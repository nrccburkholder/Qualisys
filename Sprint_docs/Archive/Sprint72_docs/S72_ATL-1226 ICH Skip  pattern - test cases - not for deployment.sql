use NRC_DataMart_ETL;
if object_id('tempdb..#work') is not null drop table #work

if object_id('tempdb..#QuestionFormTemp') is not null drop table #QuestionFormTemp
select * into #QuestionFormTemp from QuestionFormTemp where 1=2

-- find 27 questionform_ids in dbo.QuesionForm that are for ICH returns and update the list of hard-coded questionform_ids in the IN() lists below
insert into #QuestionFormTemp 
select 1 as ExtractFileID
,QUESTIONFORM_ID
,SAMPLEPOP_ID
,strLithoCode
,qf.bitcomplete as isComplete
,RECEIPTTYPE_ID
,qf.datreturned as returnDate
,DatMailed
,DatExpire
,DatGenerated
,DatPrinted
,DatBundled
,DatUndeliverable
,null as DatFirstMailed
,null as DaysFromFirstMailing
,null as DaysFromCurrentMailing
,sd.SURVEY_ID
,SurveyType_id
,0 as IsDeleted
,LangID
from qp_prod.dbo.sentmailing sm
join qp_prod.dbo.questionform qf on sm.sentmail_id=qf.sentmail_id
join qp_prod.dbo.survey_def sd on qf.survey_id=sd.survey_id
where qf.questionform_id in (202338005,202338006,202338009,202338026,202338263,202338271,202338515,202338522,202338523,202338526,202338532,202338546,202338766,202338777,202339024,202339030,202339039,202339040,202339315,202339338,202339538,202339543,202339547,202339548,202339555,202339560,202339565)


if object_id('tempdb..#bubbletemp') is not null drop table #bubbletemp
select distinct 1 as ExtractFileID, strlithocode as LithoCode, sampleunit_id, qr.qstncore as nrcQuestionCore, intresponseval as responseVal, qf.QUESTIONFORM_ID, sq.NUMMARKCOUNT
into #bubbletemp
from qp_prod.dbo.sentmailing sm
join qp_prod.dbo.questionform qf on sm.sentmail_id=qf.sentmail_id
join qp_prod.dbo.questionresult qr on qf.questionform_id=qr.questionform_id
join qp_prod.dbo.sel_qstns sq on qf.SURVEY_ID=sq.survey_id and sq.QSTNCORE=qr.QSTNCORE
where qf.questionform_id in (202338005,202338006,202338009,202338026,202338263,202338271,202338515,202338522,202338523,202338526,202338532,202338546,202338766,202338777,202339024,202339030,202339039,202339040,202339315,202339338,202339538,202339543,202339547,202339548,202339555,202339560,202339565)
--and qr.qstncore in (51198,51199,47176,47177,47193,47194)
order by 5

update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338005 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338005 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338005 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338005 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338005 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338005 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338006 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338006 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL = 3 where questionform_id=202338006 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338006 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338006 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338006 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338009 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338009 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338009 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338009 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202338009 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338009 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338026 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202338026 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338026 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338026 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338026 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338026 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338263 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202338263 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL = 3 where questionform_id=202338263 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338263 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL = 3 where questionform_id=202338263 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338263 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338271 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202338271 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338271 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338271 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202338271 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338271 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202338515 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338515 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338515 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338515 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338515 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338515 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202338522 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338522 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL = 3 where questionform_id=202338522 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338522 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338522 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338522 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202338523 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338523 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338523 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338523 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202338523 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338523 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202338526 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202338526 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338526 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338526 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338526 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338526 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202338532 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202338532 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL = 3 where questionform_id=202338532 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338532 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338532 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338532 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202338546 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202338546 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338546 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338546 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202338546 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338546 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338766 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL = 5 where questionform_id=202338766 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338766 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338766 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338766 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338766 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338777 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL = 5 where questionform_id=202338777 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL = 3 where questionform_id=202338777 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202338777 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338777 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202338777 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339024 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL = 5 where questionform_id=202339024 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202339024 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339024 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202339024 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339024 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339030 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202339030 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339030 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339030 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339030 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339030 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339039 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202339039 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339039 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339039 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339039 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339039 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339040 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202339040 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339040 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339040 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202339040 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339040 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339315 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339315 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339315 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339315 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339315 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339315 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339338 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339338 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL = 3 where questionform_id=202339338 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339338 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL = 3 where questionform_id=202339338 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339338 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339538 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339538 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339538 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339538 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202339538 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339538 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL = 3 where questionform_id=202339543 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339543 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339543 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339543 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339543 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339543 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL = 3 where questionform_id=202339547 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339547 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL = 3 where questionform_id=202339547 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339547 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339547 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339547 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339548 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339548 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339548 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339548 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202339548 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339548 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202339555 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339555 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339555 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339555 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202339555 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339555 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202339560 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339560 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339560 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339560 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202339560 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339560 and nrcQuestioncore=47194
update #bubbletemp set RESPONSEVAL = 2 where questionform_id=202339565 and nrcQuestioncore=51198	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339565 and nrcQuestioncore=51199	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339565 and nrcQuestioncore=47176	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339565 and nrcQuestioncore=47177	update #bubbletemp set RESPONSEVAL =-9 where questionform_id=202339565 and nrcQuestioncore=47193	update #bubbletemp set RESPONSEVAL = 1 where questionform_id=202339565 and nrcQuestioncore=47194;

update qr set INTRESPONSEVAL=bt.responseval
--select distinct bt.*, qr.intresponseval
from #bubbletemp bt
join qp_prod.dbo.QUESTIONRESULT qr on bt.QUESTIONFORM_ID=qr.QUESTIONFORM_ID and bt.SAMPLEUNIT_ID=qr.SAMPLEUNIT_ID and bt.nrcQuestionCore=qr.QSTNCORE
where bt.responseVal <> qr.INTRESPONSEVAL
and bt.NUMMARKCOUNT=1
